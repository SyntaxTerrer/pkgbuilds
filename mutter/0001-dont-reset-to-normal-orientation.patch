From 2ff6403c0563297994a1ef8950b76720c9c9e50a Mon Sep 17 00:00:00 2001
From: Wei <wei@fydeos.io>
Date: Tue, 16 Dec 2025 14:29:58 +0800
Subject: [PATCH] Revert "backend: Reset panel rotation when orientation is no
 longer managed"

This reverts commit e37021007de67e9358c9429fdf4f1f022a9c3ae3.
---
 src/backends/meta-monitor-manager.c   | 27 ------------------
 src/tests/monitor-orientation-tests.c | 40 ++-------------------------
 2 files changed, 2 insertions(+), 65 deletions(-)

diff --git a/src/backends/meta-monitor-manager.c b/src/backends/meta-monitor-manager.c
index 531470bf67..2275197f55 100644
--- a/src/backends/meta-monitor-manager.c
+++ b/src/backends/meta-monitor-manager.c
@@ -1329,34 +1329,7 @@ update_panel_orientation_managed (MetaMonitorManager *manager)
     }
   else
     {
-      MetaMonitorsConfig *current_config =
-        meta_monitor_config_manager_get_current (manager->config_manager);
-
       meta_orientation_manager_inhibit_tracking (orientation_manager);
-
-      /* Rotate back to normal transform when orientation goes unmanaged */
-      if (current_config)
-        {
-          g_autoptr (MetaMonitorsConfig) config = NULL;
-          g_autoptr (GError) error = NULL;
-
-          config =
-            meta_monitor_config_manager_create_for_orientation (manager->config_manager,
-                                                                current_config,
-                                                                MTK_MONITOR_TRANSFORM_NORMAL);
-
-          if (config)
-            {
-              if (!meta_monitor_manager_apply_monitors_config (manager,
-                                                               config,
-                                                               META_MONITORS_CONFIG_METHOD_TEMPORARY,
-                                                               &error))
-                {
-                  g_warning ("Failed to rotate monitor back to normal transform: %s",
-                             error->message);
-                }
-            }
-        }
     }
 }
 
diff --git a/src/tests/monitor-orientation-tests.c b/src/tests/monitor-orientation-tests.c
index 6ba0412b9a..e1bc1ca133 100644
--- a/src/tests/monitor-orientation-tests.c
+++ b/src/tests/monitor-orientation-tests.c
@@ -827,7 +827,7 @@ meta_test_monitor_orientation_initial_stored_rotated (void)
                       check_monitor_configuration_per_orientation (
                         &test_case, 0, orientation, 960, 540));
 
-  /* When no touch device is available, we reset back to normal orientation. */
+  /* When no touch device is available, the orientation change is ignored */
   g_test_message ("Removing touch device");
   n_orientation_changed = 0;
   meta_backend_test_remove_test_device (META_BACKEND_TEST (backend),
@@ -837,49 +837,13 @@ meta_test_monitor_orientation_initial_stored_rotated (void)
   meta_sensors_proxy_mock_wait_accelerometer_claimed (orientation_mock, FALSE);
   g_assert_cmpuint (n_orientation_changed, ==, 0);
 
-  META_TEST_LOG_CALL ("Checking configuration per orientation",
-                      check_monitor_configuration_per_orientation (
-                        &test_case, 0, META_ORIENTATION_NORMAL,
-                        960, 540));
-
-  g_signal_connect_swapped (orientation_manager, "sensor-active",
-                            G_CALLBACK (on_signal),
-                            &n_sensor_active);
-
-  /* Adding back the touch device, we should now pick up the orientation again */
-  n_orientation_changed = 0;
-  touch_device =
-    meta_backend_test_add_test_device (META_BACKEND_TEST (backend),
-                                       CLUTTER_TOUCHSCREEN_DEVICE, 1);
-
-  meta_sensors_proxy_mock_wait_accelerometer_claimed (orientation_mock, TRUE);
-  while (n_sensor_active != 1)
-    g_main_context_iteration (NULL, TRUE);
-
-  g_assert_cmpuint (n_orientation_changed, ==, 0);
-
-  META_TEST_LOG_CALL ("Checking configuration per orientation",
-                      check_monitor_configuration_per_orientation (
-                        &test_case, 0, META_ORIENTATION_LEFT_UP,
-                        960, 540));
-
-  /* Now remove it again, we should go to NORMAL and even when rotating we
-   * should remain in NORMAL.
-   */
-  g_test_message ("Removing touch device again");
-  meta_backend_test_remove_test_device (META_BACKEND_TEST (backend),
-                                        touch_device);
-  g_clear_object (&touch_device);
-
-  meta_sensors_proxy_mock_wait_accelerometer_claimed (orientation_mock, FALSE);
-
   g_test_message ("Rotating to right-up");
   orientation = META_ORIENTATION_RIGHT_UP;
   meta_sensors_proxy_mock_set_orientation (orientation_mock, orientation);
 
   META_TEST_LOG_CALL ("Checking configuration per orientation",
                       check_monitor_configuration_per_orientation (
-                        &test_case, 0, META_ORIENTATION_NORMAL,
+                        &test_case, 0, META_ORIENTATION_LEFT_UP,
                         960, 540));
 
   g_signal_handlers_disconnect_by_data (orientation_manager, &n_orientation_changed);
-- 
2.52.0

